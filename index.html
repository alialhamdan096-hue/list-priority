<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø±Ø§Ø²ÙŠ - Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­ÙŠ (Google Sheets)</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --maroon: #6B2D5B; --maroon-light: #8B4D7B;
            --cream: #F9F7F4; --white: #FFFFFF;
            --gray-100: #F5F3F0; --gray-500: #8B8580; --gray-700: #4A4744;
            --diamond: #1E3A5F; --platinum: #2D5B4D; --gold: #8B6914; --silver: #5A5A5A;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--cream); color: var(--gray-700); padding-bottom: 2rem; }

        .header { background: linear-gradient(135deg, var(--maroon) 0%, #5a2550 100%); padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-content { max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo-img { height: 45px; background: rgba(255,255,255,0.95); padding: 4px; border-radius: 8px; }
        .header-badge { background: #8DC63F; color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; }

        .main-container { max-width: 800px; margin: 0 auto; padding: 1.5rem 1rem; }

        .search-box { background: white; padding: 1rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 1.5rem; position: relative; }
        .search-input { width: 100%; padding: 1rem; border: 2px solid var(--gray-100); border-radius: 12px; font-family: 'Tajawal'; font-size: 1rem; transition: 0.3s; }
        .search-input:focus { border-color: var(--maroon); outline: none; }
        
        .status-bar { font-size: 0.8rem; color: var(--gray-500); margin-top: 10px; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; display: inline-block; }
        .status-dot.active { background: #4CAF50; box-shadow: 0 0 5px #4CAF50; }

        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 50; max-height: 300px; overflow-y: auto; display: none; margin-top: 5px; }
        .suggestions.show { display: block; }
        .suggestion-item { padding: 10px 15px; border-bottom: 1px solid var(--gray-100); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-item:hover { background: var(--gray-100); }
        .sugg-name { font-weight: 700; font-size: 0.9rem; }
        .sugg-cat { font-size: 0.75rem; color: var(--gray-500); }

        .cats-title { font-size: 0.9rem; font-weight: 700; margin: 15px 0 8px 0; color: var(--gray-500); }
        .cats-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 0.5rem; max-height: 250px; overflow-y: auto; padding-bottom: 5px; }
        .cat-chip { background: white; border: 1px solid var(--gray-200); padding: 8px 12px; border-radius: 20px; text-align: center; font-size: 0.8rem; cursor: pointer; transition: 0.2s; white-space: nowrap; flex-grow: 1; }
        .cat-chip:hover, .cat-chip.active { border-color: var(--maroon); background: var(--maroon); color: white; font-weight: 700; }

        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; margin-top: 1rem; }
        .results-count { font-weight: 700; color: var(--maroon); }
        .clear-btn { background: var(--gray-100); border: none; padding: 5px 12px; border-radius: 8px; cursor: pointer; font-family: 'Tajawal'; }

        .product-card { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--gray-100); transition: 0.2s; position: relative; overflow: hidden; }
        .product-card::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 6px; }
        
        .card-Diamond::before { background: var(--diamond); }
        .card-Platinum::before { background: var(--platinum); }
        .card-Gold::before { background: var(--gold); }
        .card-Silver::before { background: var(--silver); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .p-name { font-weight: 800; font-size: 1rem; color: var(--gray-700); line-height: 1.4; }
        .p-active-ingredient { font-size: 0.85rem; color: #E65100; font-weight: 600; margin-top: 2px; display: block; }
        .p-badge { font-size: 0.7rem; font-weight: 700; padding: 3px 8px; border-radius: 6px; color: white; white-space: nowrap; margin-right: 8px; height: fit-content;}
        
        .bg-Diamond { background: var(--diamond); }
        .bg-Platinum { background: var(--platinum); }
        .bg-Gold { background: var(--gold); }
        .bg-Silver { background: var(--silver); }

        .p-meta { font-size: 0.8rem; color: var(--gray-500); display: flex; gap: 10px; flex-wrap: wrap; margin-top: 0.8rem; border-top: 1px solid #f0f0f0; padding-top: 8px; }
        .p-meta span { background: var(--gray-100); padding: 2px 8px; border-radius: 4px; }

        .badge-container { margin-bottom: 8px; display: flex; gap: 5px; flex-wrap: wrap; }
        .best-choice { background-color: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 5px; }
        .your-search { background-color: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 5px; }
        .highlight-product { border: 2px solid #1565C0; background-color: #F5F9FF; transform: scale(1.02); margin-bottom: 1.5rem; }
    </style>
</head>
<body>

<header class="header">
    <div class="header-content">
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="logo.png" alt="ALRAZI" class="logo-img" onerror="this.style.display='none'; document.getElementById('txtLogo').style.display='block'">
            <span id="txtLogo" style="color: white; font-weight: 900; display: none;">ALRAZI</span>
        </div>
        <div class="header-badge">Ø¯Ù„ÙŠÙ„ 2026</div>
    </div>
</header>

<main class="main-container">
    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..." disabled>
        <div class="status-bar">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets...</span>
        </div>
        <div class="suggestions" id="suggestions"></div>
        
        <div class="cats-title">
            <span>ØªØµÙØ­ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…:</span>
            <span id="productsCount" style="font-size: 0.7rem; font-weight: normal; color: #888;">(...)</span>
        </div>
        <div class="cats-grid" id="categoriesContainer"></div>
    </div>

    <div id="resultsArea" style="display: none;">
        <div class="results-header">
            <span class="results-count" id="resCount">0 Ù†ØªØ§Ø¦Ø¬</span>
            <button class="clear-btn" onclick="clearSearch()">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
        <div id="productsList"></div>
    </div>
</main>

<script>
    // ================= CONFIGURATION =================
    // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ CSV Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ù„Ù Google Sheet
    // Ù…Ø«Ø§Ù„: https://docs.google.com/spreadsheets/d/e/...../pub?output=csv
    const SHEET_URL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø¬ÙˆØ¬Ù„_Ø´ÙŠØª_Ù‡Ù†Ø§"; 

    // ================= LOGIC =================
    let products = [];
    const priorityOrder = { 'Diamond': 1, 'Platinum': 2, 'Gold': 3, 'Silver': 4, 'R1': 5, 'R2': 6, 'Standard': 99 };

    const searchInput = document.getElementById('searchInput');
    const suggestionsBox = document.getElementById('suggestions');
    const resultsArea = document.getElementById('resultsArea');
    const productsList = document.getElementById('productsList');
    const resCount = document.getElementById('resCount');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    const productsCountLabel = document.getElementById('productsCount');

    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('DOMContentLoaded', () => {
        if(SHEET_URL.includes("Ø¶Ø¹_Ø±Ø§Ø¨Ø·")) {
            statusText.innerText = "ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Google Sheet ÙÙŠ Ø§Ù„ÙƒÙˆØ¯!";
            statusText.style.color = "red";
            return;
        }

        Papa.parse(SHEET_URL, {
            download: true,
            header: true,
            complete: function(results) {
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                products = results.data
                    .filter(row => row['Juleb name'] && row['Juleb name'].trim() !== '') // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ©
                    .map(row => ({
                        barcode: row['Internal Reference'] || '',
                        name: row['Juleb name'] || '',
                        category: row['SubCategory'] || 'Uncategorized',
                        class: row['Class'] || '',
                        priority: row['2026_List'] || 'Standard'
                    }));

                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«
                statusText.innerText = "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ù…ØªØµÙ„)";
                statusText.style.color = "green";
                statusDot.classList.add('active');
                searchInput.placeholder = "Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙØ¹Ø§Ù„Ø©ØŒ Ø£Ùˆ Ø§Ù„Ù‚Ø³Ù…...";
                searchInput.disabled = false;
                productsCountLabel.innerText = `(${products.length} Ù…Ù†ØªØ¬)`;

                // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                generateCategories();
            },
            error: function(err) {
                statusText.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!";
                statusText.style.color = "red";
                console.error("Error:", err);
            }
        });
    });

    function generateCategories() {
        const uniqueCategories = [...new Set(products.map(p => p.category))].sort();
        categoriesContainer.innerHTML = '';
        uniqueCategories.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'cat-chip';
            btn.innerText = cat;
            btn.onclick = () => searchByCategory(cat, btn);
            categoriesContainer.appendChild(btn);
        });
    }

    function searchByCategory(catName, btnElement) {
        document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        searchInput.value = catName;
        const filtered = products.filter(p => p.category === catName);
        renderResults(filtered);
    }

    searchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim().toLowerCase();
        if(val.length > 0) document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
        if(val.length < 2) { suggestionsBox.classList.remove('show'); return; }
        
        const matched = products.filter(p => 
            p.name.toLowerCase().includes(val) || 
            p.barcode.includes(val) ||
            p.category.toLowerCase().includes(val) ||
            p.class.toLowerCase().includes(val)
        ).slice(0, 5);

        let html = '';
        matched.forEach(p => {
            html += `<div class="suggestion-item" onclick="showProduct('${p.barcode}')">
                        <div>
                            <div class="sugg-name">${p.name}</div>
                            <div class="sugg-cat">ğŸ’Š ${p.class}</div>
                        </div>
                     </div>`;
        });

        if(html) {
            suggestionsBox.innerHTML = html;
            suggestionsBox.classList.add('show');
        } else {
            suggestionsBox.classList.remove('show');
        }
    });

    function showProduct(barcode) {
        const targetProduct = products.find(p => p.barcode === barcode);
        if(targetProduct) {
            let siblings = products.filter(p => p.category === targetProduct.category && p.barcode !== targetProduct.barcode);
            siblings.sort((a,b) => (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99));
            const finalList = [targetProduct, ...siblings];
            renderResults(finalList, true); 
        }
        suggestionsBox.classList.remove('show');
    }

    function renderResults(list, isSpecificSearch = false) {
        if (!isSpecificSearch) {
            list.sort((a,b) => (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99));
        }

        resultsArea.style.display = 'block';
        resCount.innerText = list.length + ' Ù†ØªØ§Ø¦Ø¬';
        
        if(list.length === 0) {
            productsList.innerHTML = '<div style="text-align:center; padding:2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
            return;
        }

        let html = '';
        list.forEach((p, index) => {
            let badgeHTML = '';
            let highlightClass = '';

            if (isSpecificSearch && index === 0) {
                badgeHTML = `<div class="your-search">ğŸ” Ø·Ù„Ø¨Ùƒ (Your Search)</div>`;
                highlightClass = 'highlight-product';
            } 
            // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø¯Ù„: Ø¥Ø¸Ù‡Ø§Ø± "Ø§Ù„Ø£ÙØ¶Ù„" Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ùˆ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†ÙØ³Ù‡)
            else if (index === (isSpecificSearch ? 1 : 0) && p.priority === 'Diamond') {
                badgeHTML = `<div class="best-choice">â­ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙØ¶Ù„ (Recommendation)</div>`;
            }

            html += `
            <div class="product-card card-${p.priority} ${highlightClass}">
                <div class="badge-container">${badgeHTML}</div>
                <div class="card-header">
                    <div>
                        <div class="p-name">${p.name}</div>
                        <div class="p-active-ingredient">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙØ¹Ø§Ù„Ø©: ${p.class}</div>
                    </div>
                    <span class="p-badge bg-${p.priority}">${p.priority}</span>
                </div>
                <div class="p-meta">
                    <span>ğŸ“‚ ${p.category}</span>
                    <span>ğŸ”¢ ${p.barcode}</span>
                </div>
            </div>`;
        });
        productsList.innerHTML = html;
    }

    function clearSearch() {
        searchInput.value = '';
        resultsArea.style.display = 'none';
        suggestionsBox.classList.remove('show');
        document.querySelectorAll('.cat-chip').forEach(b => b.classList.remove('active'));
    }

    searchInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') {
            const val = searchInput.value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(val) || 
                p.barcode.includes(val) ||
                p.category.toLowerCase().includes(val) ||
                p.class.toLowerCase().includes(val)
            );
            renderResults(filtered);
            suggestionsBox.classList.remove('show');
        }
    });
</script>

</body>
</html>
