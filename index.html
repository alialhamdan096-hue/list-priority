<script>
// ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· =================
// ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙˆØ±Ù‚Ø© ÙÙŠ Ù‚ÙˆÙ‚Ù„ Ø´ÙŠØª Ø§Ø³Ù…Ù‡Ø§ (Sheet1)
const sheetID = '1CZHMQnkhoXCpHlehZAHuYLWdpgAx-fXgn2PXT9H72-Y';
const sheetURL = `https://opensheet.elk.sh/${sheetID}/Sheet1`;

// ================= Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠ =================
const arabicKeywords = {
    "ÙÙŠØªØ§Ù…ÙŠÙ†": ["VITAMIN", "MULTIVITAMIN", "VITA"],
    "ÙÙŠØªØ§Ù…ÙŠÙ† Ø¯": ["VITAMIN D", "D3", "D 50", "D 10"],
    "Ù…Ø³ÙƒÙ†": ["PAIN", "PARACETAMOL", "IBUPROFEN", "DICLOFENAC"],
    "Ø§Ù„Ù…": ["PAIN", "ANALGESIC"],
    "ØµØ¯Ø§Ø¹": ["PARACETAMOL", "ADOL", "FEVADOL", "PANADOL"],
    "Ø­Ø±Ø§Ø±Ø©": ["PARACETAMOL", "FEVADOL", "ADOL"],
    "Ù…Ø¹Ø¯Ø©": ["STOMACH", "ANTACID", "OMEPRAZOLE", "NEXIUM"],
    "Ù‚ÙˆÙ„ÙˆÙ†": ["COLON", "DUSPATALIN", "MEBEVERINE"],
    "Ø­Ø³Ø§Ø³ÙŠØ©": ["ALLERGY", "ANTIHISTAMINE", "CETIRIZINE", "LORATADINE"],
    "Ø¬Ù„Ø¯": ["SKIN", "DERMA", "CREAM", "OINTMENT"],
    "Ø´Ø¹Ø±": ["HAIR", "BIOTIN", "CYSTINE", "MINOXIDIL"],
    "Ø§ÙƒØªØ¦Ø§Ø¨": ["DEPRESSION", "ANTIDEPRESSANT", "ESCITALOPRAM"],
    "Ø§Ù†ØªØµØ§Ø¨": ["ERECTILE", "TADALAFIL", "SILDENAFIL", "ED"],
    "Ø­Ù…Ù„": ["PREGNANCY", "PRENATAL", "FOLIC"],
    "Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ": ["ANTIBIOTIC", "AMOXICILLIN", "AZITHROMYCIN"],
    "Ø§Ù„ØªÙ‡Ø§Ø¨": ["INFECTION", "INFLAMMATION", "ANTIBIOTIC"],
    "Ø³ÙƒØ±": ["DIABETES", "METFORMIN"],
    "Ø¶ØºØ·": ["BLOOD PRESSURE", "HYPERTENSION"]
};

// ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ù„Ù„Ø£Ù„ÙˆØ§Ù†
const priorityOrder = { 'Diamond': 1, 'Platinum': 2, 'Gold': 3, 'Silver': 4, 'R1': 5, 'R2': 6 };

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let allProducts = [];
let dynamicCategories = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ù…Ù† Ø§Ù„Ù…Ù„Ù
let currentPriorityFilter = 'all';

// ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
document.addEventListener('DOMContentLoaded', () => {
    fetchData();
    setupScrollToTop();
});

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø­Ø¯Ø«Ø© Ù„ØªÙƒÙˆÙ† Ø°ÙƒÙŠØ©)
async function fetchData() {
    const listContainer = document.getElementById('productsList');
    const categoriesContainer = document.getElementById('mainCategories');
    
    listContainer.innerHTML = '<div class="loading-state">Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø´ÙŠØª... â³</div>';
    document.getElementById('resultsArea').classList.add('show');

    try {
        const response = await fetch(sheetURL);
        if (!response.ok) throw new Error("Network response was not ok");
        
        const rawData = await response.json();
        
        // ØªÙ†Ø¸ÙŠÙ ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        allProducts = rawData.map(item => {
            return {
                barcode: item['Internal Reference'] || '',
                name: item['Juleb name'] || '',
                // Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ù†Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙÙŠ Ù…Ù„ÙÙƒ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Category Ø£Ùˆ SubCategory
                // Ø³Ø£Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Category ÙƒÙ‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ùˆ SubCategory ÙƒÙ‚Ø³Ù… ÙØ±Ø¹ÙŠ
                mainCat: (item['Category'] || 'Ø¹Ø§Ù…').trim(), 
                subCat: (item['SubCategory'] || item['Category'] || 'Ø£Ø®Ø±Ù‰').trim(),
                class: item['Class'] || '',
                priority: item['2026_List'] || 'Silver'
            };
        }).filter(p => p.name); // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ©

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateStats();
        
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        buildDynamicCategories();
        
        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        listContainer.innerHTML = ''; 
        document.getElementById('resultsArea').classList.remove('show');
        
        console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allProducts.length} Ù…Ù†ØªØ¬`);

    } catch (error) {
        console.error('Error:', error);
        listContainer.innerHTML = `
            <div class="empty-state" style="color:red">
                Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.<br>
                1. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ù‚Ø© ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ø¥ÙƒØ³Ù„ Ù‡Ùˆ <b>Sheet1</b><br>
                2. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (Category, Juleb name...)
            </div>`;
    }
}

// Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function buildDynamicCategories() {
    // 1. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù
    dynamicCategories = {};
    
    allProducts.forEach(p => {
        if (!dynamicCategories[p.mainCat]) {
            dynamicCategories[p.mainCat] = new Set();
        }
        dynamicCategories[p.mainCat].add(p.subCat);
    });

    // 2. Ø±Ø³Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const container = document.getElementById('mainCategories');
    const iconsMap = { // Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø´Ù‡ÙˆØ±Ø©
        'Pharma': 'ğŸ’Š', 'Cosmetics': 'ğŸ§´', 'Medication': 'ğŸ’‰', 
        'Vitamins': 'ğŸŠ', 'Supplements': 'ğŸ’ª', 'Mom & Baby': 'ğŸ‘¶'
    };

    container.innerHTML = Object.keys(dynamicCategories).map(catName => {
        const icon = iconsMap[catName] || 'ğŸ“¦'; // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        return `
            <div class="main-cat-btn" onclick="selectDynamicMainCategory('${catName}', this)">
                <span class="main-cat-icon">${icon}</span>
                <span class="main-cat-name">${catName}</span>
            </div>
        `;
    }).join('');
}

// Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ
function selectDynamicMainCategory(mainCatName, btn) {
    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
    document.querySelectorAll('.main-cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡
    const subCats = Array.from(dynamicCategories[mainCatName]);
    renderDynamicSubCategories(subCats);
}

// Ø±Ø³Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©
function renderDynamicSubCategories(subs) {
    const container = document.getElementById('subCategories');
    const wrapper = document.getElementById('subCategoriesWrapper');
    
    container.innerHTML = subs.map(sub => `
        <div class="sub-cat-chip" onclick="filterByDynamicSubCat('${sub}', this)">${sub}</div>
    `).join('');
    
    wrapper.classList.add('show');
}

// Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ (Ù‡Ù†Ø§ ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø£Ø®ÙŠØ±Ø§Ù‹!)
function filterByDynamicSubCat(subCatName, btn) {
    document.querySelectorAll('.sub-cat-chip').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let filtered = allProducts.filter(p => p.subCat === subCatName);
    
    if (currentPriorityFilter !== 'all') {
        filtered = filtered.filter(p => p.priority === currentPriorityFilter);
    }
    
    renderResults(filtered);
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ (ÙƒÙ…Ø§ Ù‡Ùˆ)
function performSearchLogic(val) {
    const lowerVal = val.toLowerCase();
    let searchTerms = [lowerVal];
    
    Object.entries(arabicKeywords).forEach(([ar, en]) => {
        if (val.includes(ar)) {
            searchTerms = searchTerms.concat(en.map(e => e.toLowerCase()));
        }
    });
    
    let filtered = allProducts.filter(p => {
        const searchable = `${p.name} ${p.subCat} ${p.mainCat} ${p.class} ${p.barcode}`.toLowerCase();
        return searchTerms.some(term => searchable.includes(term));
    });
    
    if (currentPriorityFilter !== 'all') {
        filtered = filtered.filter(p => p.priority === currentPriorityFilter);
    }
    return filtered;
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
function renderResults(list, isSpecificSearch = false) {
    if (!isSpecificSearch) {
        list.sort((a, b) => (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99));
    }
    
    const productsList = document.getElementById('productsList');
    const resCount = document.getElementById('resCount');
    
    document.getElementById('resultsArea').classList.add('show');
    resCount.innerText = list.length + ' Ù†ØªØ§Ø¦Ø¬';
    
    if (list.length === 0) {
        productsList.innerHTML = `<div class="empty-state">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div>`;
        return;
    }
    
    productsList.innerHTML = list.map((p, i) => {
        let badgeHTML = '';
        let highlightClass = '';
        
        if (isSpecificSearch && i === 0) {
            badgeHTML = '<div class="your-search">ğŸ” Ø·Ù„Ø¨Ùƒ</div>';
            highlightClass = 'highlight-product';
        } else if (p.priority === 'Diamond' || (i === 0 && !isSpecificSearch)) {
            badgeHTML = '<div class="best-choice">â­ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙØ¶Ù„</div>';
        }
        
        return `
            <div class="product-card card-${p.priority} ${highlightClass}">
                ${badgeHTML ? `<div class="badge-container">${badgeHTML}</div>` : ''}
                <div class="card-header">
                    <div class="p-info">
                        <div class="p-name">${p.name}</div>
                        <div class="p-active-ingredient">ğŸ’Š ${p.class}</div>
                    </div>
                    <span class="p-badge bg-${p.priority}">${p.priority}</span>
                </div>
                <div class="p-meta">
                    <span>ğŸ“‚ ${p.subCat}</span>
                    <span>ğŸ”¢ ${p.barcode}</span>
                </div>
            </div>
        `;
    }).join('');
}

// ÙÙ„ØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª
function filterByPriority(priority, btn) {
    document.querySelectorAll('.priority-chip').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentPriorityFilter = priority;
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ÙˆØ¬Ø¯
    const activeSubBtn = document.querySelector('.sub-cat-chip.active');
    if (activeSubBtn) {
        filterByDynamicSubCat(activeSubBtn.innerText, activeSubBtn);
    } else if (document.getElementById('searchInput').value) {
        const filtered = performSearchLogic(document.getElementById('searchInput').value);
        renderResults(filtered);
    }
}

// Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª
const searchInput = document.getElementById('searchInput');
const suggestionsBox = document.getElementById('suggestions');

searchInput.addEventListener('input', (e) => {
    const val = e.target.value.trim();
    if (val.length < 2) { suggestionsBox.classList.remove('show'); return; }
    
    const matched = performSearchLogic(val).slice(0, 6);
    if (matched.length > 0) {
        suggestionsBox.innerHTML = matched.map(p => `
            <div class="suggestion-item" onclick="showProduct('${p.barcode}')">
                <div class="sugg-info">
                    <div class="sugg-name">${p.name}</div>
                    <div class="sugg-cat">ğŸ“‚ ${p.subCat}</div>
                </div>
                <span class="sugg-priority bg-${p.priority}">${p.priority}</span>
            </div>
        `).join('');
        suggestionsBox.classList.add('show');
    } else {
        suggestionsBox.innerHTML = '<div style="padding:15px;text-align:center;color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        suggestionsBox.classList.add('show');
    }
});

function showProduct(barcode) {
    const target = allProducts.find(p => p.barcode === barcode);
    if (target) {
        renderResults([target], true);
    }
    suggestionsBox.classList.remove('show');
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('resultsArea').classList.remove('show');
    suggestionsBox.classList.remove('show');
    document.querySelectorAll('.sub-cat-chip').forEach(b => b.classList.remove('active'));
}

function updateStats() {
    document.getElementById('totalCount').textContent = allProducts.length + ' Ù…Ù†ØªØ¬';
    document.getElementById('diamondCount').textContent = allProducts.filter(p => p.priority === 'Diamond').length;
    document.getElementById('platinumCount').textContent = allProducts.filter(p => p.priority === 'Platinum').length;
    document.getElementById('goldCount').textContent = allProducts.filter(p => p.priority === 'Gold').length;
    document.getElementById('silverCount').textContent = allProducts.filter(p => p.priority === 'Silver').length;
}

function setupScrollToTop() {
    const btn = document.getElementById('scrollTop');
    window.addEventListener('scroll', () => { btn.classList.toggle('show', window.scrollY > 300); });
}

function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
</script>
